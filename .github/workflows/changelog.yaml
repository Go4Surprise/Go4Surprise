name: Update Changelog On Any Branch

on:
  push:
    branches:
      - '**'  # Se activa en cualquier rama
    paths-ignore:
      - 'CHANGELOG.md'  # Evita bucles infinitos al ignorar cambios en el propio changelog

permissions:
  contents: write  # Permisos explícitos para modificar el contenido del repositorio

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Necesario para acceder a todo el historial de commits
          token: ${{ secrets.GITHUB_TOKEN }}  # Token explícito
      
      # Obtener el nombre de la rama actual
      - name: Get branch name
        id: branch-name
        run: echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
      
      # Configurar Git con GITHUB_TOKEN para evitar problemas de autenticación
      - name: Setup Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
      
      # Usar una acción más sencilla para generar el changelog
      - name: Generate Changelog
        id: generate_changelog
        uses: heinrichreimer/github-changelog-generator-action@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issues: true
          issuesWoLabels: true
          pullRequests: true
          prWoLabels: true
          unreleased: true
          addSections: '{"documentation":{"prefix":"**Documentation:**","labels":["documentation"]}}'
      
      # Verificar si hay cambios en el changelog - corregido el formato
      - name: Check for changes
        id: git-check
        run: |
          if git status --porcelain | grep -q 'CHANGELOG.md'; then
            echo "modified=true" >> $GITHUB_OUTPUT
          else
            echo "modified=false" >> $GITHUB_OUTPUT
          fi
      
      # Commit y push de los cambios si hay modificaciones
      - name: Commit changes
        if: steps.git-check.outputs.modified == 'true'
        run: |
          git add CHANGELOG.md
          git commit -m "docs(changelog): actualizar CHANGELOG.md en rama ${{ steps.branch-name.outputs.branch_name }}"
          git push origin ${{ steps.branch-name.outputs.branch_name }}